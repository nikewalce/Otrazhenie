{% extends "base.html" %}

{% block content %}
<div class="app-container">
    <!-- Header -->
    <header class="app-header">
        <div class="header-content">
            <div class="logo-container">
                <h1 class="app-logo">Otrazhenie</h1>
                <p class="app-subtitle">–ê–Ω–∞–ª–∏–∑ –∫–æ—Å–º–µ—Ç–∏–∫–∏</p>
            </div>
            <div class="badge-container">
                <span class="product-badge">–ü—Ä–æ–¥—É–∫—Ç–æ–≤:</span>
            </div>
        </div>
    </header>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <main class="main-content">
        <div class="results-container">
            <h1 class="results-title">üî¨ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞</h1>

            <div class="composition-section">
                <h5>–í–≤–µ–¥—ë–Ω–Ω—ã–π —Å–æ—Å—Ç–∞–≤:</h5>
                <p class="composition-text"><em>{{ composition }}</em></p>
            </div>

            <div class="analysis-table">
                <table class="ingredients-table">
                    <thead>
                        <tr>
                            <th>–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç</th>
                            <th>–§—É–Ω–∫—Ü–∏—è</th>
                            <th>–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</th>
                            <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for item in analysis %}
                        {% set score = item['safety_score'] %}
                        {% if score == '?' %}
                            {% set row_class = 'score-unknown' %}
                        {% elif score|float >= 8 %}
                            {% set row_class = 'score-danger' %}
                        {% elif score|float >= 4 %}
                            {% set row_class = 'score-warning' %}
                        {% else %}
                            {% set row_class = 'score-safe' %}
                        {% endif %}
                        <tr class="{{ row_class }}">
                            <td>{{ item['name']|capitalize }}</td>
                            <td>{{ item['function'] }}</td>
                            <td>
                                {% if score == '?' %}
                                    ‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ
                                {% elif score|float >= 8 %}
                                    ‚ùå –í—Ä–µ–¥–µ–Ω ({{ score }})
                                {% elif score|float >= 4 %}
                                    ‚ö†Ô∏è –°–ø–æ—Ä–Ω–æ ({{ score }})
                                {% else %}
                                    ‚úÖ –ë–µ–∑–æ–ø–∞—Å–µ–Ω ({{ score }})
                                {% endif %}
                            </td>
                            <td>
                                {{ item['description'] }}
                                {% if score == '?' %}
                                    <button class="add-ingredient-btn"
                                            data-ingredient="{{ item['name'] }}">
                                        ‚ûï –î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                                    </button>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="text-center">
                <a href="{{ url_for('index_bp.index') }}" class="back-button">
                    <i data-lucide="arrow-left" class="button-icon"></i>
                    –ù–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑
                </a>
            </div>

            <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
            <div id="ingredientModal" class="modal hidden">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <h2>–î–æ–±–∞–≤–∏—Ç—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç</h2>
                    <form id="ingredientForm">
                        <input type="hidden" name="name" id="modal-name">

                        <label>–§—É–Ω–∫—Ü–∏—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º:</label>
                        <input type="text" name="function_ru" required>

                        <label>–§—É–Ω–∫—Ü–∏—è –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º:</label>
                        <input type="text" name="function_en" required>

                        <label>–û–ø–∏—Å–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–∫–∞—Ç–µ–≥–æ—Ä–∏–∏):</label>
                        <textarea name="description_category"></textarea>

                        <label>–û–ø–∏—Å–∞–Ω–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞:</label>
                        <textarea name="description"></textarea>

                        <label>–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (0‚Äì10):</label>
                        <input type="number" name="safety_score" min="0" max="10" required>

                        <button type="submit">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    </form>
                </div>
            </div>

            <script>
                document.addEventListener("DOMContentLoaded", () => {
                    const modal = document.getElementById("ingredientModal");
                    const closeBtn = modal.querySelector(".close");
                    const form = document.getElementById("ingredientForm");
                    const nameInput = document.getElementById("modal-name");
                    let activeButton = null;

                    // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏
                    document.querySelectorAll(".add-ingredient-btn").forEach(button => {
                        button.addEventListener("click", () => {
                            activeButton = button;
                            nameInput.value = button.dataset.ingredient;
                            modal.classList.remove("hidden");
                        });
                    });

                    // –ó–∞–∫—Ä—ã—Ç–∏–µ
                    closeBtn.onclick = () => modal.classList.add("hidden");
                    window.onclick = (e) => { if (e.target === modal) modal.classList.add("hidden"); };

                    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
                    form.addEventListener("submit", (e) => {
                        e.preventDefault();

                        const formData = new FormData(form);
                        const payload = Object.fromEntries(formData);

                        fetch("{{ url_for('results_bp.add_unknown') }}", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify(payload)
                        })
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                modal.classList.add("hidden");
                                activeButton.textContent = "‚úî –î–æ–±–∞–≤–ª–µ–Ω–æ";
                                activeButton.disabled = true;
                            } else {
                                alert("–û—à–∏–±–∫–∞: " + data.message);
                            }
                        });
                    });
                });
            </script>

            <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
        </div>
    </main>
</div>
{% endblock %}